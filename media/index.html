
<!DOCTYPE html>
<html>
<head>
  <script src="dsp.js"></script>
  <script src="d3.v2.js"></script>
  <style>
    body { background: black; }
  </style>
</head>

<body>
  <div role="main">
    <div class="charts"></div>
      <script language="JavaScript">

function Audio(source, callback) {
  this._initialize(source, callback);
}

Audio.prototype = {
  
  _initialize: function(source, callback) { 
    var audio = this;
    this.context = new webkitAudioContext();
    this.source = this.context.createBufferSource();

    this.analysis = this.context.createJavaScriptNode(1024);
    this.analysis.onaudioprocess = function(event) { audio.audioCallback(event); };

    this.source.connect(this.analysis);
    this.analysis.connect(this.context.destination);

    this.load(source, callback);
    this._initializeFFT();
  },

  _initializeFFT: function() {
    this.data = new Array();
		
    var frameBufferSize = 4096;
	var bufferSize = frameBufferSize/4;
		
	this.mono = new Float32Array(bufferSize);
	this.peak = new Float32Array(bufferSize);
		
	this.fft = new FFT(bufferSize, 44100);

  },

  load: function(source, callback) {
    var audio = this;
    var request = new XMLHttpRequest();
    request.open("GET", source, true);
    request.responseType = "arraybuffer";
    request.onload = function() { 
      audio.source.buffer = audio.context.createBuffer(request.response, false);
      audio.source.looping = true;
      audio.source.noteOn(0);
      callback();
    }
    request.send();
  },

  routeAudio: function(event) {
    var input = {
      l: event.inputBuffer.getChannelData(0),
      r: event.inputBuffer.getChannelData(1)
    }
    var output = { 
      l: event.outputBuffer.getChannelData(0),
      r: event.outputBuffer.getChannelData(1)
    };
			
    var n = this.mono.length;

	for (var i = 0; i < n; ++i) {
	  output.l[i] = input.l[i];
      output.r[i] = input.r[i];
      this.mono[i] = (input.l[i] + input.r[i]) / 2;
    }
  },

  audioCallback: function(event) {
		
    this.routeAudio(event);   
    this.fft.forward(this.mono);
    for ( var i = 0; i < this.fft.spectrum.length; i++ ) {
        magnitude = Math.floor(this.fft.spectrum[i] * 400);
      this.data[i] = magnitude;
    }
  }
}

function Graph(selector, source) {
  this._initialize(selector, source);
}

Graph.prototype = {

  _initialize: function(selector, source) {
    var graph = this;
    this.width = 2;
    this.height = 500;
    this.source = source;
    var data = this.source.data;
    this._y = d3.scale.linear()
      .domain([0, this.height])
      .rangeRound([0, this.height]); //rangeRound is used for antialiasing
    this._x = d3.scale.linear()
      .domain([0, 1])
      .range([0, this.width]);
      var startData = []
    for (var i = 0; i < 512; i++) { startData.push(1); };
    this.chart = d3.select(selector).append("svg")
      .attr("class", "chart")
      .attr("width", this.width * startData.length)
      .attr("height", this.height);
    this.chart.selectAll("rect")
      .data(startData)
      .enter().append("rect")
      .attr("fill", "#FFF")
      .attr("x", function(d, i) { return graph._x(i) - .5; })
      .attr("y", function(d) { return graph.height - graph._y(d) - .5; })
      .attr("width", this.width)
      .attr("height", function(d) { return graph._y(d); } );
  },

  getColor: function() {
    return 'rgb(' + Math.floor(255 * Math.random()) +
      ', ' + Math.floor(255 * Math.random()) +
      ', ' + Math.floor(255 * Math.random()) + ')';
  },

  update: function() {
    var graph = this;
    var color = this.getColor();
    this.chart.selectAll("rect")
      .data(this.source.data)
      .attr("fill", color)
      .attr("x", function(d, i) { return graph._x(i) - .5; })
      .attr("y", function(d) { return graph.height - graph._y(d) - .5; })
      .attr("width", this.width)
      .attr("height", function(d) { return graph._y(d); } );

    callback = function() { graph.update() }
    t = setTimeout(callback,50);
  }

}
var audio;
var graph;

window.onload = function() {
  audio = new Audio("media/sweep.mp3", function() {
    graph = new Graph(".charts", audio);
    graph.update();
  });
}
    </script>
  </div>
</body>
</html>

